<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hand Tracking with Babylon.js</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
        }
        #renderCanvas {
            width: 100%;
            height: 100vh;
            display: block;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 10px;
            max-width: 400px;
            z-index: 100;
        }
        #startButton {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            z-index: 100;
        }
        #status {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    
    <div id="info">
        <h2>Hand Tracking Demo</h2>
        <p>This demo uses WebXR and Babylon.js to track your hands and place a 3D model on your palm.</p>
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Click "Start XR" to begin</li>
            <li>Allow camera and motion sensor permissions</li>
            <li>Hold your hand in front of the camera</li>
            <li>A 3D model will appear on your palm</li>
        </ol>
        <p><strong>Note:</strong> This works best with devices that support hand tracking, like Meta Quest or compatible smartphones.</p>
    </div>
    
    <div id="status">Waiting to start XR session...</div>
    <button id="startButton">Start XR</button>

    <!-- Babylon.js from CDN -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>

    <script>
        // Get DOM elements
        const canvas = document.getElementById("renderCanvas");
        const startButton = document.getElementById("startButton");
        const statusDiv = document.getElementById("status");

        // Create Babylon.js engine
        const engine = new BABYLON.Engine(canvas, true);
        
        // Create scene
        const createScene = function () {
            const scene = new BABYLON.Scene(engine);
            
            // Create a basic light
            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;
            
            // Create a directional light for better illumination
            const dirLight = new BABYLON.DirectionalLight("dirLight", new BABYLON.Vector3(0, -1, 0), scene);
            dirLight.position = new BABYLON.Vector3(0, 10, 0);
            dirLight.intensity = 0.5;
            
            // Create environment
            const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 10, height: 10}, scene);
            ground.position.y = -1.7;
            
            const groundMaterial = new BABYLON.StandardMaterial("groundMaterial", scene);
            groundMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.3);
            ground.material = groundMaterial;
            
            // Create a simple cube as our 3D model
            const model = BABYLON.MeshBuilder.CreateBox("palmModel", {size: 0.1}, scene);
            const material = new BABYLON.StandardMaterial("modelMaterial", scene);
            material.diffuseColor = new BABYLON.Color3(0.8, 0.3, 0.3);
            material.specularColor = new BABYLON.Color3(0.5, 0.5, 0.5);
            model.material = material;
            
            // Initially hide the model
            model.setEnabled(false);
            
            // Set up WebXR
            const xrHelper = scene.createDefaultXRExperienceAsync({
                floorMeshes: [ground]
            });
            
            // When XR is ready
            xrHelper.baseExperience.onInitialXRPoseSetObservable.add(() => {
                statusDiv.textContent = "XR session started. Waiting for hand tracking...";
                
                // Enable hand tracking
                const featuresManager = xrHelper.baseExperience.featuresManager;
                
                // Check if hand tracking is available
                if (featuresManager.enableFeature(BABYLON.WebXRFeatureName.HAND_TRACKING, "latest", {
                    xrInput: xrHelper.input
                })) {
                    statusDiv.textContent = "Hand tracking enabled. Show your hands to the camera.";
                    
                    // Listen for hand tracking events
                    xrHelper.input.onHandAddedObservable.add((hand) => {
                        statusDiv.textContent = "Hand detected! Model placed on palm.";
                        
                        // Get the palm joint
                        const palmJoint = hand.getJointMesh("palm");
                        
                        if (palmJoint) {
                            // Parent the model to the palm joint
                            model.setEnabled(true);
                            model.parent = palmJoint;
                            
                            // Position the model on the palm
                            model.position = new BABYLON.Vector3(0, 0.05, 0);
                        }
                    });
                    
                    xrHelper.input.onHandRemovedObservable.add(() => {
                        statusDiv.textContent = "Hand removed. Show your hand again to place the model.";
                        model.setEnabled(false);
                    });
                } else {
                    statusDiv.textContent = "Hand tracking not supported on this device.";
                }
            });
            
            return scene;
        };

        // Create the scene
        const scene = createScene();

        // Start XR session when button is clicked
        startButton.addEventListener("click", async () => {
            try {
                statusDiv.textContent = "Starting XR session...";
                startButton.disabled = true;
                
                // Get the XR helper from the scene
                const xrHelper = scene.getEngine().getRenderingCanvas().xr;
                
                if (xrHelper) {
                    // Start immersive VR session
                    await xrHelper.baseExperience.enterXRAsync("immersive-vr", "local-floor");
                }
            } catch (error) {
                console.error("Failed to start XR session:", error);
                statusDiv.textContent = "Failed to start XR session: " + error.message;
                startButton.disabled = false;
            }
        });

        // Render loop
        engine.runRenderLoop(() => {
            scene.render();
        });

        // Handle window resize
        window.addEventListener("resize", () => {
            engine.resize();
        });
    </script>
</body>
</html>
